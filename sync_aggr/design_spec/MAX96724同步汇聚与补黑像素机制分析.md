# MAX96724 同步汇聚与补黑像素机制分析

本文档基于 `max96724fr-user-guide.pdf`，解析MAX96724芯片的同步汇聚（Concatenation）功能，并解释其中涉及的两种“补黑像素”机制。

---

## 1. 核心概念区分：两种“补黑像素”

“补黑像素”涉及到两种完全独立的功能：**对齐补齐 (Padding)** 和 **掉线掩码 (Masking)**。

### 1.1 对齐补齐 (Padding)

- **目的**：为了满足数据对齐（Data Alignment）。
- **机制**：当一个**正常工作（已锁定）**的视频流的行像素总数不满足特定倍数要求时（例如bpp≤16时要求是8的倍数），芯片会在**每行数据的末尾**自动填充若干个黑像素，以凑足宽度。
- **触发条件**：视频流的分辨率和数据类型（bpp）不满足对齐规则。
- **关键点**：此功能**与视频是否掉线（`video_lock`失锁）无关**，它是一个静态的、基于视频格式的预处理步骤。

### 1.2 掉线掩码 (Masking)

- **目的**：为了处理视频链路丢失（掉线）的异常情况。
- **机制**：当芯片检测到某一路视频管道（Video Pipe）的 `video_lock` 信号丢失后，会自动将**这一整路视频流的输出数据全部替换为“0”**，即输出黑屏。
- **触发条件**：`video_lock` 信号失锁。
- **关键点**：这是芯片响应摄像头掉线等真实故障的机制。

---

## 2. 与心跳模式（Heartbeat Mode）的关系

- **同步汇聚的应用场景**：主要用于聚合多路**摄像头**的CSI-2数据流。
- **心跳模式的适用场景**：主要为**显示链路**设计，用于在GMSL链路层传输额外的同步信号（HS, VS, DE）。
- **结论**：在摄像头应用中，CSI-2协议本身已包含同步信息，因此心跳模式是冗余的。文档明确建议，在使用同步汇聚功能聚合摄像头数据时，应**禁用（Disable）心跳模式**，以优化链路带宽。

---

## 3. 链路丢失时的瞬时行为

当某一路视频断开，但在达到 `video_lock` 的正式检测超时（例如10ms）之前，系统如何运作？

- **问题**：在同步汇聚模式下，如果引擎死板地等待已断开的那一路数据，其他正常通道的缓存（FIFO/Line Memory）会溢出。
- **芯片的解决方案**：
    1.  芯片内部存在一个**不可配置的、非常短的硬件超时机制**。
    2.  当视频断开的瞬间，同步汇聚引擎在等待一个极短的时间后便会放弃等待。
    3.  为了不影响整体输出，引擎会为故障的那一路**插入占位数据**，然后与其他正常数据一起完成汇聚。
    4.  这个占位数据就是**全“0”数据（黑像素）**。
- **总结**：即便在达到10ms的正式失锁判断之前，芯片已经通过内部的快速超时机制，开始用“补黑”的方式处理故障路数据了。这避免了正常通道的数据溢出，并保证了输出的连续性。10ms的超时是更高层面的状态确认，而底层的硬件保护早已启动。

---

## 4. 附录：文档原文参考

以下内容摘自 `max96724fr-user-guide.pdf` 第48-50页，是对同步汇聚（Concatenation）功能的官方介绍。

### Concatenation (同步汇聚)

通常，来自多个视频管道的视频数据可以通过虚拟通道（VC）在先进先出（FCFS）的基础上聚合到一个MIPI端口。然而，在某些情况下，SoC无法解析VC，因此建议将多个流组合成一个单一的超级帧（Super Frame）。然后，SoC可以根据需要操作数据并分离图像。此操作要求禁用“管道到控制器”的映射，并且视频源必须进行帧同步。在这种模式下，所有视频流共享一个单一的VC。这也称为**同步汇聚（synchronous aggregation）**。

GMSL2 CSI-2四路解串器支持 **4WxH（并排）** 或 **Wx4H（行交错）** 两种汇聚方式。汇聚功能也可以用于少于四个流的情况。超级帧的聚合输出如Figure 20所示。在像素模式（pixel mode）下，两种汇聚形式都支持，但在隧道模式（tunnel mode）下，仅支持Wx4H汇聚。

- **4WxH 模式**: 图像像素数据被汇聚成一个超级行；行的数量保持不变。
- **Wx4H 模式**: 像素分辨率保持不变；行被汇聚。

在4WxH模式下，每个流的预期像素数基于bpp速率：

-   如果 bpp ≤ 16，则一行中的像素数必须是8的倍数。
-   如果 bpp > 16，则一行中的像素数必须是4的倍数。

如果上述标准未满足，**黑像素将填充剩余部分**。例如，如果四个RAW12（bpp=12）摄像头流（每个1026x800）被组合成一个4WxH超级帧，则一行中的总像素数预期为4128而不是4104。这是因为1026不能被8整除，最接近的8的可用倍数是1032。

在FCFS或汇聚模式下，如果某个链路失锁，MIPI输出将继续，并且LOCK引脚将取消断言。然而，**如果所有四个链路都失锁，MIPI输出将停止**。

*(注：原文中的Figure 18 和 Figure 20 分别展示了数据流输入/输出和CSI-2包结构，此处略。)

![Figure_18](.\figure18.png)
![Figure_20](.\figure20.png)
#### 4WxH 与 Wx4H 汇聚模式图解

以下是两种同步汇聚模式图示说明：

**1. 输入 (Input): 4路独立的视频流**

```
+----------------+  +----------------+  +----------------+  +----------------+
| Camera A       |  | Camera B       |  | Camera C       |  | Camera D       |
| (IM1)          |  | (IM2)          |  | (IM3)          |  | (IM4)          |
|----------------|  |----------------|  |----------------|  |----------------|
| IM1 Line 0     |  | IM2 Line 0     |  | IM3 Line 0     |  | IM4 Line 0     |
| IM1 Line 1     |  | IM2 Line 1     |  | IM3 Line 1     |  | IM4 Line 1     |
| ...            |  | ...            |  | ...            |  | ...            |
| IM1 Line N     |  | IM2 Line N     |  | IM3 Line N     |  | IM4 Line N     |
+----------------+  +----------------+  +----------------+  +----------------+
```

**2. 4WxH (Side-by-Side) 并排模式输出**

将4路视频的**每一行**在水平方向上拼接起来，形成一个“超级行”。输出分辨率变为 `(4 * Width) x Height`。

```
+--------------------------------------------------------------------+
| IM1 Line 0 | IM2 Line 0 | IM3 Line 0 | IM4 Line 0 |
+--------------------------------------------------------------------+
| IM1 Line 1 | IM2 Line 1 | IM3 Line 1 | IM4 Line 1 |
+--------------------------------------------------------------------+
| ...                                                                |
+--------------------------------------------------------------------+
| IM1 Line N | IM2 Line N | IM3 Line N | IM4 Line N |
+--------------------------------------------------------------------+
```

**3. Wx4H (Line-Interleaved) 行交错模式输出**

将4路视频的**所有行**按顺序垂直堆叠起来。输出分辨率变为 `Width x (4 * Height)`。

```
+----------------+
| IM1 Line 0     |
+----------------+
| IM2 Line 0     |
+----------------+
| IM3 Line 0     |
+----------------+
| IM4 Line 0     |
+----------------+
| IM1 Line 1     |
+----------------+
| ...            |
+----------------+
| IM4 Line N     |
+----------------+
```

## 4. 同步汇聚相关寄存器（Mask/使能）

```
Auto_Mask_En register: 
Automatically insert 0's into synchronized aggregated video outputs if a Video Pipe 0-3 video lock is lost. This allows the other video streams to continue being transmitted on the MIPI interface. 
0bXXX1: Auto video mask enabled for Video Pipe 0 
0bXX1X: Auto video mask enabled for Video Pipe 1 
0bX1XX: Auto video mask enabled for Video Pipe 2 
0b1XXX: Auto video mask enabled for Video Pipe 3

Force_Video_Mask register: 
Forces video output to be masked (send all 0's) in 4WxH or Wx4H synchronous aggregation modes. 
0bXXX1: Force video from Video Pipe 0 to be masked. 
0bXX1X: Force video from Video Pipe 1 to be masked. 
0bX1XX: Force video from Video Pipe 2 to be masked. 
0b1XXX: Force video from Video Pipe 3 to be masked. 

Video_Mask_Restart_En register: 
Automatically restarts video streams that were previously masked off due to loss of video lock
0bXXX1: Restart video from Video Pipe 0 
0bXX1X: Restart video from Video Pipe 1 
0bX1XX: Restart video from Video Pipe 2 
0b1XXX: Restart video from Video Pipe 3 

Video_Mask_Latch_Reset register: 
Reset all Video_Mask_Latched latches. Write 1 to activate reset, bit self clears and automatically releases reset. 
0x0: No action 
0x1: Reset latches
```
